<Window x:Class="PSForge.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:controls="clr-namespace:PSForge.UI.Controls"
        xmlns:vm="clr-namespace:PSForge.ViewModels"
        Title="PSForge â€” PowerShell Module GUI"
        Width="1280" Height="800"
        MinWidth="900" MinHeight="600"
        WindowStartupLocation="CenterScreen"
        Background="{StaticResource BackgroundBrush}">

    <!-- ================================================================
         MainWindow Layout
         
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Title / Connection Bar                                  â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚  Module      â”‚  Cmdlet Detail                           â”‚
         â”‚  Picker      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
         â”‚              â”‚  â”‚ Name / Synopsis / Parameter Sets     â”‚ â”‚
         â”‚  Cmdlet      â”‚  â”‚ Parameter Form                       â”‚ â”‚
         â”‚  Browser     â”‚  â”‚ Command Preview                      â”‚ â”‚
         â”‚  (grouped    â”‚  â”‚ [Run] [Cancel]                       â”‚ â”‚
         â”‚   by noun)   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
         â”‚              â”‚  Output Panel                             â”‚
         â”‚              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
         â”‚              â”‚  â”‚ [Grid][Text][JSON] [Export]          â”‚ â”‚
         â”‚              â”‚  â”‚ DataGrid / TextBox                   â”‚ â”‚
         â”‚              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚  Status Bar                                              â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         ================================================================ -->

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>   <!-- Title/connection bar -->
            <RowDefinition Height="*"/>      <!-- Main content -->
            <RowDefinition Height="Auto"/>   <!-- Status bar -->
        </Grid.RowDefinitions>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TOP BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <Border Grid.Row="0"
                Background="{StaticResource PrimaryBrush}"
                Padding="16,10">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- App title + loaded module name -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="âš¡ PSForge"
                               FontSize="18" FontWeight="Bold" Foreground="White"/>
                    <TextBlock Text="{Binding StatusText, StringFormat=' â€” {0}'}"
                               FontSize="14" Foreground="#CCFFFFFF"
                               VerticalAlignment="Center" Margin="8,0,0,0"/>
                </StackPanel>

                <!-- Connection indicator for session-based modules -->
                <StackPanel Grid.Column="1" Orientation="Horizontal"
                            Visibility="{Binding RequiresConnection, Converter={StaticResource BoolToVisibilityConverter}}">
                    <Ellipse Width="10" Height="10" Margin="0,0,6,0">
                        <Ellipse.Style>
                            <Style TargetType="Ellipse">
                                <Setter Property="Fill" Value="#FF4444"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsConnected}" Value="True">
                                        <Setter Property="Fill" Value="#44FF44"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Ellipse.Style>
                    </Ellipse>
                    <TextBlock Foreground="White" FontSize="12" VerticalAlignment="Center">
                        <TextBlock.Style>
                            <Style TargetType="TextBlock">
                                <Setter Property="Text" Value="Disconnected"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsConnected}" Value="True">
                                        <Setter Property="Text" Value="Connected"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>
                    </TextBlock>
                </StackPanel>
            </Grid>
        </Border>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN CONTENT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="300" MinWidth="200"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- â”€â”€ LEFT PANEL: Module Picker + Cmdlet Browser â”€â”€ -->
            <Border Grid.Column="0"
                    Background="{StaticResource SurfaceBrush}"
                    BorderBrush="{StaticResource BorderBrush}"
                    BorderThickness="0,0,1,0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>  <!-- Module picker -->
                        <RowDefinition Height="Auto"/>  <!-- Search -->
                        <RowDefinition Height="*"/>     <!-- Cmdlet list -->
                    </Grid.RowDefinitions>

                    <!-- Module Picker -->
                    <StackPanel Grid.Row="0" Margin="12">
                        <TextBlock Text="Module" Style="{StaticResource H3Style}"/>
                        <ComboBox ItemsSource="{Binding AvailableModules}"
                                  SelectedItem="{Binding SelectedModule}"
                                  DisplayMemberPath="Name"
                                  Style="{StaticResource FormComboBoxStyle}"
                                  Margin="0,0,0,8"/>

                        <WrapPanel>
                            <Button Content="Load Module"
                                    Command="{Binding LoadModuleCommand}"
                                    Style="{StaticResource PrimaryButtonStyle}"
                                    Margin="0,0,6,0"
                                    IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBoolConverter}}"/>

                            <!-- Connect/Disconnect buttons for session-based modules -->
                            <Button Content="Connect"
                                    Command="{Binding ConnectCommand}"
                                    Style="{StaticResource SecondaryButtonStyle}"
                                    Margin="0,0,6,0"
                                    Visibility="{Binding RequiresConnection, Converter={StaticResource BoolToVisibilityConverter}}">
                                <Button.IsEnabled>
                                    <Binding Path="IsConnected" Converter="{StaticResource InverseBoolConverter}"/>
                                </Button.IsEnabled>
                            </Button>

                            <Button Content="Disconnect"
                                    Command="{Binding DisconnectCommand}"
                                    Style="{StaticResource SecondaryButtonStyle}"
                                    Visibility="{Binding IsConnected, Converter={StaticResource BoolToVisibilityConverter}}"/>

                            <Button Content="âŸ³"
                                    Command="{Binding RefreshModulesCommand}"
                                    Style="{StaticResource SecondaryButtonStyle}"
                                    ToolTip="Refresh module list"
                                    Padding="8,8"/>
                        </WrapPanel>

                        <!-- Module Description (shown after loading) -->
                        <Border Margin="0,8,0,0" Padding="8" CornerRadius="4"
                                Background="#F0F4F8"
                                Visibility="{Binding HasModuleInfo, Converter={StaticResource BoolToVisibilityConverter}}">
                            <StackPanel>
                                <TextBlock Text="{Binding ModuleDescription}"
                                           TextWrapping="Wrap" FontSize="11.5"
                                           Foreground="#444444"
                                           Visibility="{Binding ModuleDescription, Converter={StaticResource NullToVisibilityConverter}}"
                                           Margin="0,0,0,4"/>
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="{Binding ModuleVersion, StringFormat='v{0}'}"
                                               FontSize="10" Foreground="#888888"
                                               Visibility="{Binding ModuleVersion, Converter={StaticResource NullToVisibilityConverter}}"
                                               Margin="0,0,8,0"/>
                                    <TextBlock Text="{Binding ModuleAuthor, StringFormat='by {0}'}"
                                               FontSize="10" Foreground="#888888"
                                               Visibility="{Binding ModuleAuthor, Converter={StaticResource NullToVisibilityConverter}}"/>
                                </StackPanel>
                            </StackPanel>
                        </Border>
                    </StackPanel>

                    <!-- Search Box -->
                    <Border Grid.Row="1" Padding="12,0,12,8"
                            Visibility="{Binding IsModuleLoaded, Converter={StaticResource BoolToVisibilityConverter}}">
                        <TextBox Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}">
                            <!-- Watermark using a visual brush overlay when empty -->
                            <TextBox.Style>
                                <Style TargetType="TextBox" BasedOn="{StaticResource SearchBoxStyle}">
                                    <Style.Triggers>
                                        <Trigger Property="Text" Value="">
                                            <Setter Property="Background">
                                                <Setter.Value>
                                                    <VisualBrush AlignmentX="Left" AlignmentY="Center" Stretch="None">
                                                        <VisualBrush.Visual>
                                                            <TextBlock Text="  ðŸ” Search cmdlets..."
                                                                       Foreground="#999999"
                                                                       FontFamily="Segoe UI"
                                                                       FontSize="13"/>
                                                        </VisualBrush.Visual>
                                                    </VisualBrush>
                                                </Setter.Value>
                                            </Setter>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBox.Style>
                        </TextBox>
                    </Border>

                    <!-- Cmdlet List (grouped by noun) -->
                    <TreeView Grid.Row="2"
                              ItemsSource="{Binding GroupedCmdlets}"
                              BorderThickness="0"
                              Padding="8,0"
                              Visibility="{Binding IsModuleLoaded, Converter={StaticResource BoolToVisibilityConverter}}">
                        <TreeView.ItemTemplate>
                            <HierarchicalDataTemplate DataType="{x:Type vm:CmdletGroupViewModel}"
                                                      ItemsSource="{Binding Cmdlets}">
                                <!-- Group header (Noun) -->
                                <TextBlock FontWeight="SemiBold" FontSize="13">
                                    <Run Text="{Binding Noun, Mode=OneWay}"/>
                                    <Run Text="{Binding Cmdlets.Count, Mode=OneWay, StringFormat=' ({0})'}"
                                         Foreground="{StaticResource TextSecondaryBrush}"/>
                                </TextBlock>

                                <!-- Cmdlet items -->
                                <HierarchicalDataTemplate.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding Name}"
                                                   FontSize="12"
                                                   Padding="4,2"
                                                   Cursor="Hand"
                                                   MouseLeftButtonDown="CmdletItem_Click">
                                            <TextBlock.ToolTip>
                                                <TextBlock Text="{Binding Synopsis}"
                                                           MaxWidth="400"
                                                           TextWrapping="Wrap"/>
                                            </TextBlock.ToolTip>
                                        </TextBlock>
                                    </DataTemplate>
                                </HierarchicalDataTemplate.ItemTemplate>
                            </HierarchicalDataTemplate>
                        </TreeView.ItemTemplate>
                    </TreeView>
                </Grid>
            </Border>

            <!-- Splitter -->
            <GridSplitter Grid.Column="1"
                          Width="4"
                          HorizontalAlignment="Center"
                          VerticalAlignment="Stretch"
                          Background="{StaticResource BorderBrush}"
                          Cursor="SizeWE"/>

            <!-- â”€â”€ RIGHT PANEL: Cmdlet Detail + Output â”€â”€ -->
            <Grid Grid.Column="2">
                <Grid.RowDefinitions>
                    <RowDefinition Height="2*" MinHeight="250"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*" MinHeight="120"/>
                </Grid.RowDefinitions>

                <!-- Cmdlet Detail View (shown when a cmdlet is selected) -->
                <Border Grid.Row="0"
                        Padding="16"
                        Visibility="{Binding ActiveCmdletViewModel, Converter={StaticResource NullToVisibilityConverter}}"
                        DataContext="{Binding ActiveCmdletViewModel}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>  <!-- Name + synopsis -->
                            <RowDefinition Height="Auto"/>  <!-- Parameter set tabs -->
                            <RowDefinition Height="*"/>     <!-- Parameter form -->
                            <RowDefinition Height="Auto"/>  <!-- Command preview -->
                            <RowDefinition Height="Auto"/>  <!-- Action buttons -->
                        </Grid.RowDefinitions>

                        <!-- Cmdlet header -->
                        <StackPanel Grid.Row="0" Margin="0,0,0,12">
                            <TextBlock Text="{Binding Name}" Style="{StaticResource H2Style}"/>
                            <TextBlock Text="{Binding Synopsis}"
                                       Style="{StaticResource SecondaryTextStyle}"
                                       TextWrapping="Wrap"/>
                        </StackPanel>

                        <!-- Parameter Set Tabs -->
                        <TabControl Grid.Row="1"
                                    ItemsSource="{Binding ParameterSets}"
                                    SelectedItem="{Binding SelectedParameterSet}"
                                    Margin="0,0,0,8"
                                    Visibility="{Binding ParameterSets.Count, Converter={StaticResource NullToVisibilityConverter}}">
                            <TabControl.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock FontSize="12">
                                        <Run Text="{Binding Name, Mode=OneWay}"/>
                                        <Run Text=" âœ“" Foreground="{StaticResource SuccessBrush}"
                                             FontWeight="Bold">
                                            <Run.Style>
                                                <Style TargetType="Run">
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsDefault}" Value="False">
                                                            <Setter Property="Text" Value=""/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Run.Style>
                                        </Run>
                                    </TextBlock>
                                </DataTemplate>
                            </TabControl.ItemTemplate>
                            <TabControl.ContentTemplate>
                                <DataTemplate>
                                    <!-- Empty content â€” the form is bound separately below -->
                                </DataTemplate>
                            </TabControl.ContentTemplate>
                        </TabControl>

                        <!-- Parameter Form + Detail Panel -->
                        <Grid Grid.Row="2">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <!-- Parameter Form -->
                            <controls:ParameterFormControl Grid.Column="0"/>

                            <!-- Parameter Detail Sidebar (shown when a parameter is clicked) -->
                            <Border Grid.Column="1"
                                    Width="260"
                                    Background="#F5F7FA"
                                    BorderBrush="{StaticResource BorderBrush}"
                                    BorderThickness="1,0,0,0"
                                    Padding="12,8"
                                    Margin="8,0,0,0"
                                    Visibility="{Binding HasSelectedParameter, Converter={StaticResource BoolToVisibilityConverter}}">
                                <ScrollViewer VerticalScrollBarVisibility="Auto"
                                              HorizontalScrollBarVisibility="Disabled">
                                    <StackPanel DataContext="{Binding SelectedParameter}">
                                        <!-- Header with close button -->
                                        <DockPanel Margin="0,0,0,8">
                                            <Button Content="âœ•" DockPanel.Dock="Right"
                                                    Click="CloseParameterDetail_Click"
                                                    Background="Transparent" BorderThickness="0"
                                                    Foreground="#888888" FontSize="14"
                                                    Cursor="Hand" Padding="4,0"
                                                    VerticalAlignment="Top"/>
                                            <TextBlock Text="{Binding Name}" FontWeight="Bold"
                                                       FontSize="14" Foreground="{StaticResource PrimaryBrush}"
                                                       TextWrapping="Wrap"/>
                                        </DockPanel>

                                        <!-- Type -->
                                        <TextBlock FontSize="11" Margin="0,0,0,8" Foreground="#666666">
                                            <Run Text="Type:" FontWeight="SemiBold"/>
                                            <Run Text="{Binding TypeName, Mode=OneWay}"/>
                                        </TextBlock>

                                        <!-- Required/Optional badge -->
                                        <Border CornerRadius="3" Padding="6,2" Margin="0,0,0,8"
                                                HorizontalAlignment="Left">
                                            <Border.Style>
                                                <Style TargetType="Border">
                                                    <Setter Property="Background" Value="#E8E8E8"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsMandatory}" Value="True">
                                                            <Setter Property="Background" Value="#FDE7E9"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Border.Style>
                                            <TextBlock FontSize="11" FontWeight="SemiBold">
                                                <TextBlock.Style>
                                                    <Style TargetType="TextBlock">
                                                        <Setter Property="Foreground" Value="#666666"/>
                                                        <Setter Property="Text" Value="Optional"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding IsMandatory}" Value="True">
                                                                <Setter Property="Foreground" Value="#D13438"/>
                                                                <Setter Property="Text" Value="Required"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </TextBlock.Style>
                                            </TextBlock>
                                        </Border>

                                        <!-- Description -->
                                        <TextBlock Text="{Binding Description}" TextWrapping="Wrap"
                                                   FontSize="12" Foreground="#333333" Margin="0,0,0,10"
                                                   Visibility="{Binding HasDescription, Converter={StaticResource BoolToVisibilityConverter}}"/>

                                        <!-- Properties grid -->
                                        <Border BorderBrush="{StaticResource BorderBrush}"
                                                BorderThickness="0,1,0,0" Padding="0,8,0,0">
                                            <StackPanel>
                                                <!-- Position -->
                                                <StackPanel Margin="0,0,0,4">
                                                    <TextBlock Text="Position" FontSize="10"
                                                               Foreground="#999999" FontWeight="SemiBold"/>
                                                    <TextBlock Text="{Binding PositionDisplay}"
                                                               FontSize="11.5" Foreground="#333333"/>
                                                </StackPanel>

                                                <!-- Pipeline Input -->
                                                <StackPanel Margin="0,0,0,4">
                                                    <TextBlock Text="Pipeline Input" FontSize="10"
                                                               Foreground="#999999" FontWeight="SemiBold"/>
                                                    <TextBlock FontSize="11.5" Foreground="#333333">
                                                        <TextBlock.Style>
                                                            <Style TargetType="TextBlock">
                                                                <Setter Property="Text" Value="No"/>
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding AcceptsPipelineInput}" Value="True">
                                                                        <Setter Property="Text" Value="Yes"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </TextBlock.Style>
                                                    </TextBlock>
                                                </StackPanel>

                                                <!-- Wildcards -->
                                                <StackPanel Margin="0,0,0,4">
                                                    <TextBlock Text="Wildcards" FontSize="10"
                                                               Foreground="#999999" FontWeight="SemiBold"/>
                                                    <TextBlock FontSize="11.5" Foreground="#333333">
                                                        <TextBlock.Style>
                                                            <Style TargetType="TextBlock">
                                                                <Setter Property="Text" Value="No"/>
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding AcceptsWildcards}" Value="True">
                                                                        <Setter Property="Text" Value="Yes"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </TextBlock.Style>
                                                    </TextBlock>
                                                </StackPanel>

                                                <!-- Aliases -->
                                                <StackPanel Margin="0,0,0,4"
                                                            Visibility="{Binding HasAliases, Converter={StaticResource BoolToVisibilityConverter}}">
                                                    <TextBlock Text="Aliases" FontSize="10"
                                                               Foreground="#999999" FontWeight="SemiBold"/>
                                                    <TextBlock Text="{Binding AliasesDisplay}"
                                                               FontSize="11.5" Foreground="#333333"
                                                               TextWrapping="Wrap"/>
                                                </StackPanel>

                                                <!-- ValidateSet -->
                                                <StackPanel Margin="0,0,0,4"
                                                            Visibility="{Binding HasValidateSet, Converter={StaticResource BoolToVisibilityConverter}}">
                                                    <TextBlock Text="Allowed Values" FontSize="10"
                                                               Foreground="#999999" FontWeight="SemiBold"/>
                                                    <TextBlock Text="{Binding ValidateSetDisplay}"
                                                               FontSize="11.5" Foreground="#333333"
                                                               TextWrapping="Wrap"/>
                                                </StackPanel>

                                                <!-- Parameter Set -->
                                                <StackPanel Margin="0,0,0,4">
                                                    <TextBlock Text="Parameter Set" FontSize="10"
                                                               Foreground="#999999" FontWeight="SemiBold"/>
                                                    <TextBlock Text="{Binding ParameterSetName}"
                                                               FontSize="11.5" Foreground="#333333"
                                                               TextWrapping="Wrap"/>
                                                </StackPanel>
                                            </StackPanel>
                                        </Border>
                                    </StackPanel>
                                </ScrollViewer>
                            </Border>
                        </Grid>

                        <!-- Command Preview -->
                        <controls:CommandPreviewControl Grid.Row="3" Margin="0,8,0,8"/>

                        <!-- Action Buttons -->
                        <StackPanel Grid.Row="4" Orientation="Horizontal"
                                    HorizontalAlignment="Left">
                            <Button Content="â–¶ Run"
                                    Command="{Binding RunCommand}"
                                    Style="{StaticResource PrimaryButtonStyle}"
                                    Margin="0,0,8,0"
                                    MinWidth="100"/>
                            <Button Content="âœ• Cancel"
                                    Command="{Binding CancelCommand}"
                                    Style="{StaticResource DangerButtonStyle}"
                                    MinWidth="100"
                                    Visibility="{Binding IsExecuting, Converter={StaticResource BoolToVisibilityConverter}}"/>

                            <!-- Spinner during execution -->
                            <TextBlock Text="â³ Executing..."
                                       VerticalAlignment="Center"
                                       Margin="12,0,0,0"
                                       Style="{StaticResource SecondaryTextStyle}"
                                       Visibility="{Binding IsExecuting, Converter={StaticResource BoolToVisibilityConverter}}"/>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- No cmdlet selected placeholder -->
                <Border Grid.Row="0"
                        Visibility="{Binding ActiveCmdletViewModel, Converter={StaticResource NullToVisibilityConverter}, ConverterParameter=Invert}">
                    <TextBlock Text="Select a cmdlet from the left panel to begin"
                               Style="{StaticResource SecondaryTextStyle}"
                               HorizontalAlignment="Center"
                               VerticalAlignment="Center"
                               FontSize="16"/>
                </Border>

                <!-- Horizontal splitter between detail and output -->
                <GridSplitter Grid.Row="1"
                              Height="4"
                              HorizontalAlignment="Stretch"
                              VerticalAlignment="Center"
                              Background="{StaticResource BorderBrush}"
                              Cursor="SizeNS"/>

                <!-- â”€â”€ OUTPUT PANEL â”€â”€ -->
                <Border Grid.Row="2"
                        Background="{StaticResource SurfaceBrush}"
                        BorderBrush="{StaticResource BorderBrush}"
                        BorderThickness="0,1,0,0"
                        DataContext="{Binding OutputViewModel}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>  <!-- Toolbar -->
                            <RowDefinition Height="*"/>     <!-- Output content -->
                            <RowDefinition Height="Auto"/>  <!-- Footer (duration, status) -->
                        </Grid.RowDefinitions>

                        <!-- Output Toolbar -->
                        <Border Grid.Row="0" Padding="12,8"
                                Background="{StaticResource BackgroundBrush}"
                                BorderBrush="{StaticResource BorderBrush}"
                                BorderThickness="0,0,0,1">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="Output" Style="{StaticResource H3Style}"
                                           VerticalAlignment="Center" Margin="0,0,16,0"/>

                                <!-- View mode toggle buttons -->
                                <RadioButton Content="Grid" GroupName="OutputMode"
                                             IsChecked="True"
                                             Checked="OutputMode_Grid"
                                             Margin="0,0,4,0" Padding="8,4"/>
                                <RadioButton Content="Text" GroupName="OutputMode"
                                             Checked="OutputMode_Text"
                                             Margin="0,0,4,0" Padding="8,4"/>
                                <RadioButton Content="JSON" GroupName="OutputMode"
                                             Checked="OutputMode_Json"
                                             Margin="0,0,16,0" Padding="8,4"/>

                                <!-- Export buttons -->
                                <Button Content="ðŸ“‹ CSV"
                                        Command="{Binding ExportCsvCommand}"
                                        Style="{StaticResource SecondaryButtonStyle}"
                                        Padding="8,4" Margin="0,0,4,0"
                                        IsEnabled="{Binding HasOutput}"/>
                                <Button Content="ðŸ“‹ JSON"
                                        Command="{Binding ExportJsonCommand}"
                                        Style="{StaticResource SecondaryButtonStyle}"
                                        Padding="8,4" Margin="0,0,4,0"
                                        IsEnabled="{Binding HasOutput}"/>
                                <Button Content="Clear"
                                        Command="{Binding ClearOutputCommand}"
                                        Style="{StaticResource SecondaryButtonStyle}"
                                        Padding="8,4"/>
                            </StackPanel>
                        </Border>

                        <!-- Output Content Area -->
                        <Grid Grid.Row="1" Margin="12,8">
                            <!-- Error display -->
                            <Border Background="#FFF0F0"
                                    BorderBrush="{StaticResource ErrorBrush}"
                                    BorderThickness="1"
                                    CornerRadius="4"
                                    Padding="12"
                                    Visibility="{Binding HasError, Converter={StaticResource BoolToVisibilityConverter}}"
                                    Margin="0,0,0,8"
                                    VerticalAlignment="Top">
                                <StackPanel>
                                    <TextBlock Text="âš  Error" FontWeight="Bold"
                                               Foreground="{StaticResource ErrorBrush}"
                                               Margin="0,0,0,4"/>
                                    <TextBlock Text="{Binding ErrorText}"
                                               Style="{StaticResource ErrorTextStyle}"
                                               FontFamily="Cascadia Code, Consolas, Courier New"
                                               FontSize="12"/>
                                </StackPanel>
                            </Border>

                            <!-- Warning display -->
                            <Border Background="#FFF8F0"
                                    BorderBrush="{StaticResource WarningBrush}"
                                    BorderThickness="1"
                                    CornerRadius="4"
                                    Padding="12"
                                    Visibility="{Binding WarningText, Converter={StaticResource NullToVisibilityConverter}}"
                                    Margin="0,0,0,8"
                                    VerticalAlignment="Top">
                                <TextBlock Text="{Binding WarningText}"
                                           Style="{StaticResource WarningTextStyle}"/>
                            </Border>

                            <!-- Grid view: visible when HasOutput=True AND mode=Grid -->
                            <controls:OutputGridControl>
                                <controls:OutputGridControl.Style>
                                    <Style TargetType="controls:OutputGridControl">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                        <Style.Triggers>
                                            <MultiDataTrigger>
                                                <MultiDataTrigger.Conditions>
                                                    <Condition Binding="{Binding HasOutput}" Value="True"/>
                                                    <Condition Binding="{Binding SelectedOutputMode}" Value="Grid"/>
                                                </MultiDataTrigger.Conditions>
                                                <Setter Property="Visibility" Value="Visible"/>
                                            </MultiDataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </controls:OutputGridControl.Style>
                            </controls:OutputGridControl>

                            <!-- Text/JSON view: visible when HasOutput=True AND mode=Text or Json -->
                            <controls:OutputTextControl>
                                <controls:OutputTextControl.Style>
                                    <Style TargetType="controls:OutputTextControl">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                        <Style.Triggers>
                                            <MultiDataTrigger>
                                                <MultiDataTrigger.Conditions>
                                                    <Condition Binding="{Binding HasOutput}" Value="True"/>
                                                    <Condition Binding="{Binding SelectedOutputMode}" Value="Text"/>
                                                </MultiDataTrigger.Conditions>
                                                <Setter Property="Visibility" Value="Visible"/>
                                            </MultiDataTrigger>
                                            <MultiDataTrigger>
                                                <MultiDataTrigger.Conditions>
                                                    <Condition Binding="{Binding HasOutput}" Value="True"/>
                                                    <Condition Binding="{Binding SelectedOutputMode}" Value="Json"/>
                                                </MultiDataTrigger.Conditions>
                                                <Setter Property="Visibility" Value="Visible"/>
                                            </MultiDataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </controls:OutputTextControl.Style>
                            </controls:OutputTextControl>

                            <!-- Status message (no output / success) -->
                            <TextBlock Text="{Binding StatusMessage}"
                                       Style="{StaticResource SuccessTextStyle}"
                                       HorizontalAlignment="Center"
                                       VerticalAlignment="Center"
                                       FontSize="14"
                                       Visibility="{Binding StatusMessage, Converter={StaticResource NullToVisibilityConverter}}"/>
                        </Grid>

                        <!-- Output Footer -->
                        <Border Grid.Row="2" Padding="12,6"
                                Background="{StaticResource BackgroundBrush}"
                                BorderBrush="{StaticResource BorderBrush}"
                                BorderThickness="0,1,0,0">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Style="{StaticResource SecondaryTextStyle}"
                                           Visibility="{Binding ExecutedCommand, Converter={StaticResource NullToVisibilityConverter}}">
                                    <Run Text="Command: "/>
                                    <Run Text="{Binding ExecutedCommand, Mode=OneWay}"
                                         FontFamily="Cascadia Code, Consolas, Courier New"/>
                                </TextBlock>
                                <TextBlock Text="{Binding DurationText, StringFormat='  |  Duration: {0}'}"
                                           Style="{StaticResource SecondaryTextStyle}"
                                           Visibility="{Binding DurationText, Converter={StaticResource NullToVisibilityConverter}}"
                                           Margin="12,0,0,0"/>
                            </StackPanel>
                        </Border>
                    </Grid>
                </Border>
            </Grid>
        </Grid>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STATUS BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <Border Grid.Row="2"
                Background="{StaticResource PrimaryBrush}"
                Padding="8,4">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBlock Grid.Column="0"
                           Text="{Binding StatusText}"
                           Foreground="White"
                           FontSize="12"
                           VerticalAlignment="Center"/>

                <!-- Loading spinner -->
                <TextBlock Grid.Column="1"
                           Text="â³ Loading..."
                           Foreground="#CCFFFFFF"
                           FontSize="12"
                           VerticalAlignment="Center"
                           Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisibilityConverter}}"/>
            </Grid>
        </Border>

        <!-- Error Banner (overlay) -->
        <Border Grid.Row="1"
                VerticalAlignment="Top"
                HorizontalAlignment="Stretch"
                Background="#FFF0F0"
                BorderBrush="{StaticResource ErrorBrush}"
                BorderThickness="0,0,0,2"
                Padding="16,8"
                Visibility="{Binding ErrorMessage, Converter={StaticResource NullToVisibilityConverter}}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBlock Grid.Column="0"
                           Text="{Binding ErrorMessage}"
                           Style="{StaticResource ErrorTextStyle}"
                           VerticalAlignment="Center"/>
                <Button Grid.Column="1"
                        Content="âœ•"
                        Click="DismissError_Click"
                        Background="Transparent"
                        BorderThickness="0"
                        Foreground="{StaticResource ErrorBrush}"
                        FontSize="16"
                        Cursor="Hand"
                        Padding="8,2"/>
            </Grid>
        </Border>
    </Grid>
</Window>
